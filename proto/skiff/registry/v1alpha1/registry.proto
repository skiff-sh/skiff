syntax = "proto3";

package skiff.registry.v1alpha1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/skiff-sh/skiff/api/go/skiff/registry/v1alpha1";

message Registry {
  string name = 1 [(buf.validate.field).string.min_len = 1];

  string description = 2;

  repeated Package packages = 3;
}

message Package {
  // The name of the package. This should be unique between all packages within a registry.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // A short description of the purpose of this package and what it contains. Should be LLM-friendly. Supports markdown.
  string description = 2 [(buf.validate.field).string.min_len = 1];

  repeated File files = 3;

  // If a field does not have a default, it is marked as required.
  optional Schema schema = 4;
}

message Schema {
  option (buf.validate.message).cel = {
    id: "unique_field_names"
    message: "all field names must be unique"
    expression: "this.fields.map(v, v.name).unique()"
  };

  repeated Field fields = 1;
}

message Field {
  // buf:lint:ignore ENUM_VALUE_UPPER_SNAKE_CASE
  // buf:lint:ignore ENUM_VALUE_UPPER_SNAKE_CASE
  // buf:lint:ignore ENUM_VALUE_PREFIX
  // buf:lint:ignore ENUM_ZERO_VALUE_SUFFIX
  enum Type {
    string = 0;
    bool = 1;
    number = 2;
    array = 3;
  }

  option (buf.validate.message).cel = {
    message: 'enums only supported for type number, or string'
    id: 'enums_type_invalid'
    expression: 'has(this.enum) ? this.type in [skiff.registry.v1alpha1.Field.Type.string, skiff.registry.v1alpha1.Field.Type.number] : true'
  };

  option (buf.validate.message).cel = {
    message: 'items required for arrays'
    id: 'items_required'
    expression: 'this.type == skiff.registry.v1alpha1.Field.Type.array ? (has(this.items) && has(this.items.type)): true'
  };

  option (buf.validate.message).cel = {
    id: "default_must_be_in_enum"
    message: "default value must be one of enum values when enum is set"
    expression: "has(this.default) && size(this.enum) > 0 ? this.default in this.enum : true"
  };

  message SubField {
    option (buf.validate.message).cel = {
      message: 'items required for arrays'
      id: 'items_required'
      expression: 'this.type == skiff.registry.v1alpha1.Field.Type.array ? (has(this.items) && has(this.items.type)): true'
    };

    option (buf.validate.message).cel = {
      message: 'enums only supported for type number or string'
      id: 'enums_type_invalid'
      expression: 'has(this.enum) ? this.type in [skiff.registry.v1alpha1.Field.Type.string, skiff.registry.v1alpha1.Field.Type.number] : true'
    };

    // Required. Can be a string or number.
    optional Type type = 1 [
      (buf.validate.field).required = true,
      (buf.validate.field).enum = {
        in: [
          0,
          2
        ]
      }
    ];

    // If the type is set to "array", this specifies the underlying type. Required if type is "array".
    optional SubField items = 2;

    // Restrict your options to a set of values to choose.
    optional google.protobuf.ListValue enum = 3;
  }

  // The name of the field. This must be unique between all fields.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // The expected type of the field.
  optional Type type = 2 [(buf.validate.field).required = true];

  // If the type is set to "array", this specifies the underlying type. Required if type is "array".
  optional SubField items = 3;

  // A short description of the field. This is highly recommended to provide context to all consumers of your package.
  optional string description = 4;

  // The default value. If set, the field will be marked as optional. If the enum field is set, this field must be one of the enum values.
  optional google.protobuf.Value default = 5;

  // Restrict your options to a set of values to choose.
  optional google.protobuf.ListValue enum = 6;
}

message File {
  // buf:lint:ignore ENUM_VALUE_UPPER_SNAKE_CASE
  // buf:lint:ignore ENUM_VALUE_UPPER_SNAKE_CASE
  // buf:lint:ignore ENUM_VALUE_PREFIX
  // buf:lint:ignore ENUM_ZERO_VALUE_SUFFIX
  enum Type {
    plain = 0;
    template = 1;
    plugin = 2;
  }

  // The path to the template relative to the root of the registry. The root of the registry is the directory housing your 'registry.json' file. Cannot be outside of the registry root.
  string path = 1 [(buf.validate.field).string.min_len = 1];

  // The target path of the rendered template relative to the root of the project. Accepts template parameters.
  string target = 2 [(buf.validate.field).string.min_len = 1];

  // The contents of the file. You do not need to populate this manually.
  optional bytes content = 3;

  // The type of the file.
  Type type = 4;
}
